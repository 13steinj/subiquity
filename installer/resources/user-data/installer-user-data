#cloud-config
#http_proxy: http://my-proxy:3129/
password: passw0rd
chpasswd: { expire: False }
output: {all: '| tee -a /var/log/cloud-init-output.log'}
packages:
 - python-urwid
 - python3-urwid
runcmd:
    - cp /usr/share/doc/python-urwid/examples/input_test.py /tmp/installer.py
    - tar -C /usr/local -xf /tmp/subiquity.tar
    - chmod +x /tmp/installer.py /usr/local/bin/subiquity
    - systemctl enable subiquity.service
    - systemctl stop getty@tty1.service
#    - systemctl stop serial-getty@ttyS0.service
    - /tmp/installer.sh
    - telinit 0
write_files:
-   content: |
        #!/bin/bash

        chvt 1
        systemctl start subiquity
        # restart getty service after exiting "installer"
        # systemctl stop serial-getty@ttyS0.service
    path: /tmp/installer.sh
    owner: root:root
    permissions: '0755'
-   content: |
        [Unit]
        Description=Ubuntu Servier Installer Service
        After=getty@tty1.service

        [Service]
        Type=oneshot
        Environment="PYTHONPATH=/usr/local"
        ExecStart=/usr/local/bin/subiquity
        StandardInput=tty-force
        StandardOutput=tty
        StandardError=tty
        TTYPath=/dev/console
        TTYReset=yes
        TTYVHangup=yes
        TTYVTDisallocate=yes

        [Install]
        WantedBy=default.target
    path: /lib/systemd/system/subiquity.service
    owner: root:root
    permissions: '0755'

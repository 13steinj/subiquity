#!/bin/sh
set -e

trap true HUP INT QUIT TSTP

# agetty only sets ICRNL if it has read the username and seen whether
# it was terminated by CR or NL. We pass -n to agetty so that hasn't
# happened and need to force it on. Yay UNIX!
stty icrnl -echo

# check if we have extrausers that have no password set
if grep -qE '^[-a-z0-9+.-_]+:x:' /var/lib/extrausers/passwd && ! grep -qE '^[-a-z0-9+.-_]+:\$[0-9]+\$.*:' /var/lib/extrausers/shadow; then
    cat /usr/share/subiquity/console-conf-ssh-login-only
    # FIXME: do something better
    read REPLY
fi

# all done and the user has a password
if [ -e  /var/lib/console-conf/complete ]; then
    exit 0
fi

if [ "$(snap managed)" = "true" ]; then
    touch /var/lib/console-conf/complete
    exit 0
fi

cat /usr/share/subiquity/console-conf-wait
read REPLY
stty echo
exec console-conf "$@"

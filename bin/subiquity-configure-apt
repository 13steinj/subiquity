#!/bin/bash -eux
PY=$1
HAS_NETWORK=$2
mount -t tmpfs tmpfs "$TARGET_MOUNT_POINT/run"
mkdir -p "$TARGET_MOUNT_POINT/run/cdrom"
mount --bind /cdrom "$TARGET_MOUNT_POINT/run/cdrom"

setup_overlay () {
    local dir=$1
    local t=$(mktemp -d)
    mkdir $t/work $t/upper
    mount -t overlay overlay -o lowerdir=$dir,workdir=$t/work,upperdir=$t/upper $dir
}

$PY -m curtin apt-config

setup_overlay $TARGET_MOUNT_POINT/etc/apt
setup_overlay $TARGET_MOUNT_POINT/var/lib/apt/lists

cat > "/tmp/sources.list" <<EOF
deb file:///run/cdrom $(lsb_release -sc) main restricted
EOF
if [ $HAS_NETWORK = 'true' ]; then
    cat "$TARGET_MOUNT_POINT/etc/apt/sources.list" >> "/tmp/sources.list"
fi
mv /tmp/sources.list "$TARGET_MOUNT_POINT/etc/apt/sources.list"
$PY -m curtin in-target -- apt-get update
